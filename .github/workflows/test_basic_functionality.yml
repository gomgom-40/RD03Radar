name: Basic Functionality Test

on:
  push:
    branches: [ main, master ]
    paths:
      - 'src/**'
      - 'examples/**'
      - 'library.properties'
  pull_request:
    branches: [ main, master ]
    paths:
      - 'src/**'
      - 'examples/**'
      - 'library.properties'

jobs:
  test-basic:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Arduino CLI
      uses: arduino/setup-arduino-cli@v1

    - name: Install ESP32 core
      run: |
        arduino-cli config init --overwrite --additional-urls "https://raw.githubusercontent.com/espressif/arduino-esp32/gh-pages/package_esp32_index.json"
        arduino-cli core update-index
        arduino-cli core install esp32:esp32

    - name: Install ESP8266 core
      run: |
        arduino-cli config add board_manager.additional_urls "https://arduino.esp8266.com/stable/package_esp8266com_index.json"
        arduino-cli core update-index
        arduino-cli core install esp8266:esp8266

    - name: Install dependencies
      run: |
        arduino-cli lib install PubSubClient
        arduino-cli lib install ArduinoJson

    - name: Test library installation
      run: |
        mkdir -p ~/Arduino/libraries/RD03Radar
        cp src/*.h src/*.cpp library.properties ~/Arduino/libraries/RD03Radar/
        [ -f ~/Arduino/libraries/RD03Radar/RD03Radar.h ] || exit 1
        [ -f ~/Arduino/libraries/RD03Radar/RD03Radar.cpp ] || exit 1
        echo "✅ Library structure verified"

    - name: Pre-build library with MQTT enabled
      run: |
        mkdir -p /tmp/dummy
        cat > /tmp/dummy/dummy.ino << 'EOF'
#define RD03_ENABLE_MQTT
#include <RD03Radar.h>
void setup() {}
void loop() {}
EOF
        arduino-cli compile --fqbn esp8266:esp8266:generic /tmp/dummy/dummy.ino
        echo "✅ Library pre-built with RD03_ENABLE_MQTT"

    - name: Test header file compilation
      run: |
        cat > /tmp/test_sketch.ino << 'EOF'
#define RD03_ENABLE_MQTT
#include <RD03Radar.h>
RD03Config config;
RD03Radar radar(Serial2, config);
void setup() { radar.begin(16, 17); }
void loop() { radar.loop(); }
EOF
        arduino-cli compile --fqbn esp32:esp32:esp32 /tmp/test_sketch.ino
        arduino-cli compile --fqbn esp8266:esp8266:generic /tmp/test_sketch.ino
        echo "✅ Header compilation successful"

    - name: Test basic example compilation
      run: |
        arduino-cli compile --fqbn esp32:esp32:esp32 examples/BasicPresenceDetection/BasicPresenceDetection.ino
        arduino-cli compile --fqbn esp8266:esp8266:generic examples/BasicPresenceDetection/BasicPresenceDetection.ino
        echo "✅ Basic example compilation successful"

    - name: Compile MQTT Example
      run: |
        arduino-cli compile --fqbn esp8266:esp8266:generic \
          -D RD03_ENABLE_MQTT \
          examples/MQTT_Example/MQTT_Example.ino
        echo "✅ MQTT example compiled successfully"

    - name: Validate library metadata
      run: |
        grep -q "name=RD03Radar" library.properties || exit 1
        grep -q "version=1.1.0" library.properties || exit 1
        grep -q "architectures=esp32,esp8266" library.properties || exit 1
        echo "✅ Library metadata validated"

    - name: Check file permissions
      run: |
        [ -r src/RD03Radar.h ] || exit 1
        [ -r src/RD03Radar.cpp ] || exit 1
        [ -r library.properties ] || exit 1
        echo "✅ File permissions OK"
