name: Basic Functionality Test

on:
  push:
    branches: [ main, master ]
    paths:
      - 'src/**'
      - 'examples/**'
      - 'library.properties'
  pull_request:
    branches: [ main, master ]
    paths:
      - 'src/**'
      - 'examples/**'
      - 'library.properties'

jobs:
  test-basic:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Arduino CLI
      uses: arduino/setup-arduino-cli@v1

    - name: Install ESP32 core
      run: |
        arduino-cli config init --additional-urls "https://raw.githubusercontent.com/espressif/arduino-esp32/gh-pages/package_esp32_index.json"
        arduino-cli core update-index
        arduino-cli core install esp32:esp32

    - name: Install ESP8266 core
      run: |
        arduino-cli config init --additional-urls "https://arduino.esp8266.com/stable/package_esp8266com_index.json"
        arduino-cli core update-index
        arduino-cli core install esp8266:esp8266

    - name: Install dependencies
      run: |
        arduino-cli lib install PubSubClient
        arduino-cli lib install ArduinoJson

    - name: Test library installation
      run: |
        # Test local library installation
        mkdir -p ~/Arduino/libraries/RD03Radar
        cp -r src/* ~/Arduino/libraries/RD03Radar/
        cp library.properties ~/Arduino/libraries/RD03Radar/

        # Verify library structure
        [ -f ~/Arduino/libraries/RD03Radar/RD03Radar.h ] || exit 1
        [ -f ~/Arduino/libraries/RD03Radar/RD03Radar.cpp ] || exit 1
        echo "✅ Library structure verified"

    - name: Test header file compilation
      run: |
        # Create minimal test sketch
        cat > /tmp/test_sketch.ino << 'EOF'
        #include <RD03Radar.h>

        RD03Config config;
        RD03Radar radar(Serial2, config);

        void setup() {
          radar.begin(16, 17);
        }

        void loop() {
          radar.loop();
        }
        EOF

        # Test compilation
        arduino-cli compile --fqbn esp32:esp32:esp32 /tmp/test_sketch.ino
        arduino-cli compile --fqbn esp8266:esp8266:generic /tmp/test_sketch.ino
        echo "✅ Header compilation successful"

    - name: Test basic example compilation
      run: |
        arduino-cli compile --fqbn esp32:esp32:esp32 examples/BasicPresenceDetection/BasicPresenceDetection.ino
        arduino-cli compile --fqbn esp8266:esp8266:generic examples/BasicPresenceDetection/BasicPresenceDetection.ino
        echo "✅ Basic example compilation successful"

    - name: Validate library metadata
      run: |
        # Check library.properties
        grep -q "name=RD03Radar" library.properties || exit 1
        grep -q "version=1.1.0" library.properties || exit 1
        grep -q "architectures=esp32,esp8266,avr" library.properties || exit 1
        echo "✅ Library metadata validated"

    - name: Check file permissions
      run: |
        # Ensure source files are readable
        [ -r src/RD03Radar.h ] || exit 1
        [ -r src/RD03Radar.cpp ] || exit 1
        [ -r library.properties ] || exit 1
        echo "✅ File permissions OK"
